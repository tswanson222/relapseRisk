---
output:
  html_document:
    toc: true
    toc_float: true
params: 
  participant: NULL
  set_title: "TITLE"
  set_date: "DATE"
  stoplights: NULL
title: "`r params$set_title`"
date: "`r params$set_date`"
---

```{r setup, include = FALSE}
library(relapseRisk)
participant <- params$participant

risk <- predictRisk(participant, pilr = TRUE)
risk <- risk[nrow(risk), 'risk']

epsi <- pilrdata(file = participant, survey = 'epsi')
idas <- pilrdata(file = participant, survey = 'idas')
```

# Risk Level

<center>
```{r stoplight, echo = FALSE, out.width = "150px", fig.cap = paste("Risk Level:", risk)}
light <- ifelse(risk == 'HIGH', 'red',
                ifelse(risk == 'LOW', 'green', 
                       ifelse(risk == 'MODERATE', 'yellow', 'none')))

if(light != 'none'){
  suppressWarnings(knitr::include_graphics(params$stoplights[light]))
} else {
  message('Patient did not complete both surveys this week. Risk score cannot be calculated.')
}

```
</center>

# EPSI

```{r thetaViz1, echo = FALSE, message = FALSE, warning = FALSE}
if(length(epsi)>1){
  plotThetas(data = epsi)
}
```

```{r table1, echo = FALSE}
if(length(epsi)>1 & epsi$non_response==FALSE){
  itemTable(data = epsi)
} 
if(length(epsi)>1 & epsi$non_response==TRUE){
   message('Patient did not complete the EPSI survey this week. Display results from the last completed survey.')
   itemTable(data = epsi) 
}
if(length(epsi)<=1){
  message('Patient did not complete the EPSI survey this week and there are no previous records.')
}
```

# IDAS

```{r thetaViz2, echo = FALSE, message = FALSE, warning = FALSE}
if(length(idas)>1){
  plotThetas(data = idas)
}
```

```{r table2, echo = FALSE}
if(length(idas)>1 & idas$non_response==FALSE){
  itemTable(data = idas)
} 
if(length(idas)>1 & idas$non_response==TRUE){
   message('Patient did not complete the IDAS survey this week. Display results from the last completed survey.')
   itemTable(data = idas) 
}
if(length(idas)<=1){
  message('Patient did not complete the IDAS survey this week and there are no previous records.')
}
```
